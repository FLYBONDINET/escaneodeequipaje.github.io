<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>üì¶ Plataforma Esc√°ner de Valijas</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      box-sizing: border-box;
      background: #f4f6f9;
      min-height: 100vh;
    }
    h2 {
      margin-bottom: 20px;
      color: #2c3e50;
    }
    .card {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      max-width: 700px;
      width: 100%;
      margin-bottom: 20px;
    }
    label {
      font-weight: bold;
      margin-bottom: 5px;
      display: inline-block;
    }
    input, button {
      padding: 10px;
      margin: 5px 0;
      font-size: 1rem;
      border-radius: 6px;
      border: 1px solid #ccc;
      width: 100%;
      box-sizing: border-box;
    }
    button {
      cursor: pointer;
      border: none;
      font-weight: bold;
    }
    .btn-primary { background: #3498db; color: white; }
    .btn-primary:hover { background: #2980b9; }
    .btn-secondary { background: #95a5a6; color: white; }
    .btn-secondary:hover { background: #7f8c8d; }
    .btn-success { background: #27ae60; color: white; }
    .btn-success:hover { background: #1e8449; }
    #video {
      width: 100%;
      aspect-ratio: 16 / 9;
      border: 2px solid #ccc;
      border-radius: 8px;
      background: black;
      margin: 10px 0;
      object-fit: cover;
    }
    #listado {
      max-height: 200px;
      overflow-y: auto;
      background: #fafafa;
      border-radius: 8px;
      padding: 10px;
      border: 1px solid #ddd;
    }
    #listado li {
      padding: 6px;
      border-bottom: 1px solid #eee;
    }
    #contador {
      font-weight: bold;
      margin: 10px 0;
    }
  </style>
</head>
<body>
  <h2>üì¶ Plataforma Esc√°ner de Valijas</h2>

  <div class="card">
    <label for="vuelo">‚úàÔ∏è N√∫mero de vuelo:</label>
    <input type="text" id="vuelo" placeholder="Ej: AR1234" autocomplete="off" />

    <button id="startScan" class="btn-primary">Iniciar Escaneo</button>
    <button id="toggleFlash" class="btn-secondary" disabled>Linterna üî¶</button>
  </div>

  <div class="card">
    <video id="video" autoplay playsinline></video>
  </div>

  <div class="card">
    <h3>üìã Listado</h3>
    <div id="contador">Total: 0</div>
    <ul id="listado"></ul>
    <hr>
    <label for="manualCodigo">‚ûï Ingresar c√≥digo manual:</label>
    <input type="text" id="manualCodigo" placeholder="Escriba o pegue c√≥digo de valija" />
    <button id="agregarManual" class="btn-secondary">Agregar Manualmente</button>
  </div>

  <div class="card">
    <button id="finalizar" class="btn-success">‚úÖ Finalizar</button>
  </div>

  <script src="https://unpkg.com/@zxing/library@latest"></script>
  <script>
    let listado = [];
    const listadoElem = document.getElementById('listado');
    const contadorElem = document.getElementById('contador');
    const videoElem = document.getElementById('video');
    const startScanBtn = document.getElementById('startScan');
    const toggleFlashBtn = document.getElementById('toggleFlash');
    const manualInput = document.getElementById('manualCodigo');
    const manualBtn = document.getElementById('agregarManual');
    const finalizarBtn = document.getElementById('finalizar');
    
    let codeReader = null;
    let stream = null;
    let track = null;
    let torchOn = false;
    let vueloActivo = "";

    startScanBtn.addEventListener('click', async () => {
      const vuelo = document.getElementById('vuelo').value.trim();
      if (!vuelo) {
        alert("Ingrese n√∫mero de vuelo");
        return;
      }
      vueloActivo = vuelo;
      if (codeReader) detenerScanner();
      listado = [];
      listadoElem.innerHTML = '';
      contadorElem.textContent = 'Total: 0';
      await iniciarScanner(vuelo);
    });

    manualBtn.addEventListener('click', () => {
      const codigo = manualInput.value.trim();
      if (!codigo) return;
      if (listado.includes(codigo)) {
        alert("‚ö†Ô∏è C√≥digo repetido");
      } else {
        listado.push(codigo);
        agregarFila(codigo);
        enviarDatos(vueloActivo, codigo);
      }
      manualInput.value = "";
    });

    finalizarBtn.addEventListener('click', () => {
      if (!vueloActivo) {
        alert("No hay vuelo activo");
        return;
      }
      alert(`‚úàÔ∏è Vuelo ${vueloActivo}\nüì¶ Se han contabilizado ${listado.length} valijas.`);
    });

    toggleFlashBtn.addEventListener('click', () => {
      if (!track) return;
      const imageCapture = new ImageCapture(track);
      imageCapture.getPhotoCapabilities().then(capabilities => {
        if (!capabilities.torch) {
          alert("La linterna no est√° soportada en este dispositivo.");
          return;
        }
        torchOn = !torchOn;
        track.applyConstraints({ advanced: [{torch: torchOn}] })
          .then(() => { toggleFlashBtn.textContent = torchOn ? 'Apagar Linterna üî¶' : 'Encender Linterna üî¶'; })
          .catch(e => console.error('Error al cambiar linterna:', e));
      });
    });

    async function iniciarScanner(vuelo) {
      try {
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
        videoElem.srcObject = stream;
        track = stream.getVideoTracks()[0];

        const capabilities = track.getCapabilities();
        if (capabilities.torch) {
          toggleFlashBtn.disabled = false;
          torchOn = false;
          toggleFlashBtn.textContent = 'Encender Linterna üî¶';
        } else {
          toggleFlashBtn.disabled = true;
        }

        codeReader = new ZXing.BrowserMultiFormatReader();
        codeReader.decodeFromVideoDevice(null, 'video', (result, err) => {
          if (result) {
            const codigo = result.text.trim();
            if (!listado.includes(codigo)) {
              listado.push(codigo);
              agregarFila(codigo);
              enviarDatos(vuelo, codigo);
            }
          }
          if (err && !(err instanceof ZXing.NotFoundException)) {
            console.error(err);
          }
        });

        // Forzar reintentos de enfoque cada 5s
        setInterval(() => {
          if (track) {
            track.applyConstraints({ focusMode: "continuous" }).catch(() => {});
          }
        }, 5000);

      } catch (error) {
        alert("Error al acceder a la c√°mara: " + error.message);
      }
    }

    function detenerScanner() {
      if (codeReader) { codeReader.reset(); codeReader = null; }
      if (stream) { stream.getTracks().forEach(t => t.stop()); stream = null; }
      toggleFlashBtn.disabled = true;
      torchOn = false;
      toggleFlashBtn.textContent = 'Linterna üî¶';
    }

    function agregarFila(codigo) {
      const li = document.createElement('li');
      li.textContent = codigo;
      listadoElem.appendChild(li);
      contadorElem.textContent = "Total: " + listado.length;
    }

    function enviarDatos(vuelo, codigo) {
      fetch("https://script.google.com/macros/s/AKfycbzQH6WipQZb7krjpmYTuqNKlbEasYf_9d0o70NscaRlEjnwior8Q1X7aB5-gD6b5qhN/exec", {
        method: "POST",
        body: JSON.stringify({ vuelo: vuelo, codigo: codigo }),
        headers: { "Content-Type": "application/json" }
      })
      .then(r => r.text())
      .then(res => console.log("Guardado:", res))
      .catch(err => console.error("Error:", err));
    }

    window.addEventListener('beforeunload', () => detenerScanner());
  </script>
</body>
</html>
