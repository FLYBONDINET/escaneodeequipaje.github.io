<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Esc치ner de Valijas</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      box-sizing: border-box;
      background: #f9f9f9;
      min-height: 100vh;
    }
    h2 {
      margin-bottom: 10px;
    }
    label {
      font-weight: bold;
    }
    input, button {
      padding: 10px;
      margin: 5px;
      font-size: 1rem;
      border-radius: 5px;
      border: 1px solid #ccc;
    }
    #video {
      width: 100%;
      max-width: 600px;
      aspect-ratio: 16 / 9;
      border: 2px solid #ccc;
      border-radius: 8px;
      background: black;
      margin: 10px 0;
      object-fit: cover;
    }
    #listado {
      max-width: 600px;
      width: 100%;
      text-align: left;
      padding-left: 20px;
      max-height: 200px;
      overflow-y: auto;
      background: white;
      border-radius: 8px;
      box-shadow: 0 0 6px rgba(0,0,0,0.1);
    }
    #contador {
      font-weight: bold;
      margin: 10px 0;
    }
    #controls {
      display: flex;
      justify-content: center;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 10px;
      width: 100%;
      max-width: 600px;
    }
    @media (max-width: 480px) {
      input, button {
        width: 100%;
        box-sizing: border-box;
      }
      #controls {
        flex-direction: column;
        align-items: center;
      }
    }
  </style>
</head>
<body>
  <h2>游닍 Esc치ner de Valijas</h2>
  <div id="controls">
    <label for="vuelo">N칰mero de vuelo:</label>
    <input type="text" id="vuelo" placeholder="Ej: AR1234" autocomplete="off" />
    <button id="startScan">Iniciar Escaneo</button>
    <button id="toggleFlash" disabled>Linterna 游댡</button>
  </div>

  <video id="video" autoplay playsinline></video>

  <h3>Listado</h3>
  <div id="contador">Total: 0</div>
  <ul id="listado"></ul>

  <script src="https://unpkg.com/@zxing/library@latest"></script>
  <script>
    let listado = [];
    const listadoElem = document.getElementById('listado');
    const contadorElem = document.getElementById('contador');
    const videoElem = document.getElementById('video');
    const startScanBtn = document.getElementById('startScan');
    const toggleFlashBtn = document.getElementById('toggleFlash');
    let codeReader = null;
    let stream = null;
    let track = null;
    let torchOn = false;

    startScanBtn.addEventListener('click', async () => {
      const vuelo = document.getElementById('vuelo').value.trim();
      if (!vuelo) {
        alert("Ingrese n칰mero de vuelo");
        return;
      }
      if (codeReader) {
        // Si ya est치 corriendo, reiniciar la c치mara
        detenerScanner();
      }
      listado = [];
      listadoElem.innerHTML = '';
      contadorElem.textContent = 'Total: 0';
      await iniciarScanner(vuelo);
    });

    toggleFlashBtn.addEventListener('click', () => {
      if (!track) return;
      const imageCapture = new ImageCapture(track);
      imageCapture.getPhotoCapabilities().then(capabilities => {
        if (!capabilities.torch) {
          alert("La linterna no est치 soportada en este dispositivo.");
          return;
        }
        torchOn = !torchOn;
        track.applyConstraints({
          advanced: [{torch: torchOn}]
        }).then(() => {
          toggleFlashBtn.textContent = torchOn ? 'Apagar Linterna 游댡' : 'Encender Linterna 游댡';
        }).catch(e => {
          console.error('Error al cambiar estado de linterna:', e);
        });
      }).catch(e => {
        console.error('No se pudo acceder a capacidades de la c치mara:', e);
      });
    });

    async function iniciarScanner(vuelo) {
      try {
        // Pedir c치mara con autofocus y linterna si est치 disponible
        stream = await navigator.mediaDevices.getUserMedia({
          video: {
            facingMode: { exact: "environment" },
            focusMode: "continuous" // intento de autofocus, pero no todos los navegadores lo soportan
          }
        });
        videoElem.srcObject = stream;
        track = stream.getVideoTracks()[0];

        // Verificar si el dispositivo soporta linterna
        const capabilities = track.getCapabilities();
        if (capabilities.torch) {
          toggleFlashBtn.disabled = false;
          torchOn = false;
          toggleFlashBtn.textContent = 'Encender Linterna 游댡';
        } else {
          toggleFlashBtn.disabled = true;
        }

        codeReader = new ZXing.BrowserMultiFormatReader();

        codeReader.decodeFromVideoDevice(null, 'video', (result, err) => {
          if (result) {
            const codigo = result.text.trim();
            if (listado.includes(codigo)) {
              // C칩digo repetido, no lo agregamos ni enviamos de nuevo
              // Puedes avisar si quieres, pero mejor evitar alert repetidos
              console.log("C칩digo repetido:", codigo);
            } else {
              listado.push(codigo);
              agregarFila(codigo);
              enviarDatos(vuelo, codigo);
            }
          }
          if (err && !(err instanceof ZXing.NotFoundException)) {
            // Mostrar errores que no sean solo "no encontrado"
            console.error(err);
          }
        });
      } catch (error) {
        alert("Error al acceder a la c치mara: " + error.message);
      }
    }

    function detenerScanner() {
      if (codeReader) {
        codeReader.reset();
        codeReader = null;
      }
      if (stream) {
        stream.getTracks().forEach(t => t.stop());
        stream = null;
      }
      toggleFlashBtn.disabled = true;
      torchOn = false;
      toggleFlashBtn.textContent = 'Linterna 游댡';
    }

    function agregarFila(codigo) {
      const li = document.createElement('li');
      li.textContent = codigo;
      listadoElem.appendChild(li);
      contadorElem.textContent = "Total: " + listado.length;
    }

    function enviarDatos(vuelo, codigo) {
      fetch("https://script.google.com/macros/s/AKfycbzQH6WipQZb7krjpmYTuqNKlbEasYf_9d0o70NscaRlEjnwior8Q1X7aB5-gD6b5qhN/exec", {
        method: "POST",
        body: JSON.stringify({ vuelo: vuelo, codigo: codigo }),
        headers: { "Content-Type": "application/json" }
      })
      .then(r => r.text())
      .then(res => console.log("Guardado:", res))
      .catch(err => console.error("Error:", err));
    }

    // Detener la c치mara cuando se cierre la pesta침a o se recargue
    window.addEventListener('beforeunload', () => {
      detenerScanner();
    });
  </script>
</body>
</html>
