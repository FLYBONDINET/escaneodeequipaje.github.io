<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>EscÃ¡ner de Valijas</title>
  <style>
    body { font-family: Arial; text-align: center; margin: 20px; }
    video { width: 100%; max-width: 400px; border: 2px solid #ccc; margin: 10px 0; }
    #listado { margin-top: 20px; text-align: left; display: inline-block; }
    #contador { font-weight: bold; margin: 10px 0; }
    input, button { padding: 10px; margin: 5px; }
  </style>
</head>
<body>
  <h2>ðŸ“¦ EscÃ¡ner de Valijas</h2>
  <label>NÃºmero de vuelo:</label>
  <input type="text" id="vuelo" placeholder="Ej: AR1234"><br>
  <button id="startScan">Iniciar Escaneo</button>
  <br>
  <video id="video" autoplay playsinline></video>

  <h3>Listado</h3>
  <div id="contador">Total: 0</div>
  <ul id="listado"></ul>

  <script src="https://unpkg.com/@zxing/library@latest"></script>
  <script>
    const listado = [];
    const listadoElem = document.getElementById('listado');
    const contadorElem = document.getElementById('contador');
    const videoElem = document.getElementById('video');

    document.getElementById('startScan').addEventListener('click', () => {
      const vuelo = document.getElementById('vuelo').value.trim();
      if (!vuelo) {
        alert("Ingrese nÃºmero de vuelo");
        return;
      }
      iniciarScanner(vuelo);
    });

    async function iniciarScanner(vuelo) {
      try {
        // Abre la cÃ¡mara trasera
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: "environment" }
        });
        videoElem.srcObject = stream;

        // Lector ZXing
        const codeReader = new ZXing.BrowserMultiFormatReader();
        codeReader.decodeFromVideoDevice(null, 'video', (result, err) => {
          if (result) {
            const codigo = result.text.trim();
            if (listado.includes(codigo)) {
              alert("âš  CÃ³digo repetido: " + codigo);
            } else {
              listado.push(codigo);
              agregarFila(codigo);
              enviarDatos(vuelo, codigo);
            }
          }
        });
      } catch (error) {
        alert("Error al acceder a la cÃ¡mara: " + error);
      }
    }

    function agregarFila(codigo) {
      const li = document.createElement('li');
      li.textContent = codigo;
      listadoElem.appendChild(li);
      contadorElem.textContent = "Total: " + listado.length;
    }

    function enviarDatos(vuelo, codigo) {
      fetch("https://script.google.com/macros/s/AKfycbzQH6WipQZb7krjpmYTuqNKlbEasYf_9d0o70NscaRlEjnwior8Q1X7aB5-gD6b5qhN/exec", {
        method: "POST",
        body: JSON.stringify({ vuelo: vuelo, codigo: codigo }),
        headers: { "Content-Type": "application/json" }
      })
      .then(r => r.text())
      .then(res => console.log("Guardado:", res))
      .catch(err => console.error("Error:", err));
    }
  </script>
</body>
</html>
